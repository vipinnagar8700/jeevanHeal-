"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const key_cache_1 = require("./key_cache");
const key_cache_limiter_1 = require("./key_cache_limiter");
const fetcher_1 = require("../fetcher");
function createKeyCache({ limit, wait_map, default_value } = {}) {
    // create the key cache
    const cache = new key_cache_1.KeyCache({
        default_value
    });
    let limiter;
    // if limit was defined create a limiter
    if (limit !== undefined) {
        limiter = new key_cache_limiter_1.KeyCacheLimiter(limit);
        const update = (key, value) => {
            limiter.up(key);
        };
        // listen on cache actions
        cache.on(key_cache_1.KeyCacheEvents.set, update);
        cache.on(key_cache_1.KeyCacheEvents.get, update);
        cache.on(key_cache_1.KeyCacheEvents.remove, (key, value) => {
            limiter.remove(key);
        });
        cache.on(key_cache_1.KeyCacheEvents.clean, () => {
            limiter.clean();
        });
        limiter.onLimited(key => {
            cache.remove(key);
        });
    }
    const tracker = new fetcher_1.FetchTracker({ wait_map });
    tracker.onEnded((key, value) => {
        cache.set(key, value);
    });
    return {
        limiter,
        cache,
        tracker
    };
}
exports.createKeyCache = createKeyCache;
//# sourceMappingURL=create_key_cache.js.map